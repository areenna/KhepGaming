<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>{{ product.title }} ‚Ä¢ Details</title>
<style>
:root{--g1:#7c4dff;--g2:#00e5ff;--g3:#ff6ec7;--bg:#0f1020;--text:#f9fbff;--border:#ffffff26}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,Arial,sans-serif;color:var(--text);
  background:radial-gradient(circle at 10% 10%,var(--g2),transparent 30%),
             radial-gradient(circle at 90% 20%,var(--g3),transparent 35%),
             radial-gradient(circle at 50% 90%,var(--g1),transparent 35%),var(--bg);
  min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:24px}
.wrap{width:min(1100px,96vw);display:grid;gap:18px;grid-template-columns:1.2fr 1fr}
@media (max-width:900px){.wrap{grid-template-columns:1fr}}
.gallery{background:#00000050;border:1px solid var(--border);border-radius:16px;overflow:hidden}
.mainimg{width:100%;aspect-ratio:4/3;object-fit:cover;display:block;background:#0b0d22}
.meta{background:#00000050;border:1px solid var(--border);border-radius:16px;padding:16px;display:grid;gap:12px}
h1{margin:0;font-size:28px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.price{font-weight:900}
.badge{padding:6px 10px;border-radius:999px;background:#ffffff18;border:1px solid var(--border);font-weight:700}
.rating .star{font-size:18px}
.rating .off{opacity:.35}
.section{background:#00000040;border:1px solid var(--border);border-radius:12px;padding:14px}
.actions{display:flex;gap:12px;flex-wrap:wrap}
.btn{ text-decoration:none;padding:12px 16px;border-radius:12px;font-weight:800;border:1px solid var(--border);
      background:#ffffff16;color:var(--text)}
.btn.primary{ background:linear-gradient(90deg,var(--g1),var(--g2),var(--g3)); color:#111; border:0; box-shadow:0 6px 16px #0006 }
.btn:hover{ background:#ffffff28 }
.small{opacity:.9}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#1a1c3d;padding:20px;border-radius:16px;width:min(400px,90%);text-align:center}
.stars{display:flex;justify-content:center;gap:6px;font-size:32px;margin:10px 0}
.stars span{cursor:pointer;color:#888}
.stars span.active{color:#ffcc00}
</style>
</head>
<body>

<div class="wrap">
  <div class="gallery">
    <img class="mainimg"
         src="{{ product.image_url or '/static/no-image.png' }}"
         alt="{{ product.title }} image"
         onerror="this.src='https://via.placeholder.com/960x720?text=No+Image';"/>
  </div>

  <aside class="meta">
    <h1>{{ product.title }}</h1>

    <div class="row small">
      <span class="badge">üìç {{ product.location }}</span>
      <span class="badge">üóìÔ∏è {{ product.available_summary }}</span>
      <span class="badge price">{{ product.price_per_day }} BDT/day</span>
      {% if product.status == 'rented' %}
        <span class="badge" style="border-color:#ffb4b4;color:#ffb4b4">Not available</span>
      {% endif %}
    </div>

    <div class="row rating">
      {% set r = (product.avg_rating or 0)|round(0, 'floor') %}
      {% for i in range(5) %}
        {% if i < r %}<span class="star">‚òÖ</span>{% else %}<span class="star off">‚òÖ</span>{% endif %}
      {% endfor %}
      <b>&nbsp;{{ '%.1f'|format(product.avg_rating or 0) }}</b>
      <small>({{ product.rating_count }})</small>
    </div>

    <div class="actions">
      <a class="btn" href="/dashboard">‚Üê Back to dashboard</a>

      {% set is_owner = (session.get('user_id') == product.owner_id) %}

      {% if is_owner %}
        <a class="btn primary" style="pointer-events:none;opacity:.5;cursor:not-allowed;">Your item</a>
      {% elif product.status == 'available' %}
        <a class="btn primary" href="/rent/{{ product.id }}/request">Rent this item</a>
      {% else %}
        <a class="btn primary" style="pointer-events:none;opacity:.5;cursor:not-allowed;">Not Available</a>
      {% endif %}

      <a class="btn" href="/user/{{ product.owner_id }}">View owner</a>
      <a class="btn" id="rateBtn">‚≠ê Rate this product</a>
    </div>
  </aside>

  <section class="section" style="grid-column:1/-1;">
    <h3>Description</h3>
    <p class="small">{{ product.description }}</p>
  </section>

  <section class="section" style="grid-column:1/-1;">
    <h3>Available Dates</h3>
    <p class="small">{{ product.available_summary }}</p>
  </section>

  {% if reviews %}
  <section class="section" style="grid-column:1/-1;">
    <h3>User Reviews</h3>
    <ul>
      {% for r in reviews %}
        <li><b>{{ r.reviewer_name }}</b>: {{ r.rating }}‚òÖ - {{ r.comment or '' }}</li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}
</div>

<!-- Modal for rating -->
<div class="modal" id="rateModal">
  <div class="modal-content">
    <h2>Rate this product</h2>
    <form method="post" action="/products/{{ product.id }}/rate">
      <div class="stars" id="starContainer">
        {% for i in range(1,6) %}
          {% if user_review and i <= user_review.rating %}
            <span data-value="{{ i }}" class="active">‚òÖ</span>
          {% else %}
            <span data-value="{{ i }}">‚òÖ</span>
          {% endif %}
        {% endfor %}
      </div>
      <input type="hidden" name="rating" id="ratingInput" value="{{ user_review.rating if user_review else '' }}" required>
      <textarea name="comment" placeholder="Write a short review (optional)" style="width:100%;border-radius:8px;padding:8px;">{{ user_review.comment if user_review else '' }}</textarea>
      <br><br>
      <button type="submit" class="btn primary">Submit</button>
      <a class="btn" href="#" onclick="document.getElementById('rateModal').classList.remove('active');return false;">Cancel</a>
    </form>
  </div>
</div>

<script>
const rateBtn = document.getElementById("rateBtn");
const modal = document.getElementById("rateModal");
const stars = document.querySelectorAll("#starContainer span");
const ratingInput = document.getElementById("ratingInput");

rateBtn.addEventListener("click", () => { modal.classList.add("active"); });

stars.forEach(star => {
  star.addEventListener("click", () => {
    const val = parseInt(star.getAttribute("data-value"), 10);
    ratingInput.value = val;
    stars.forEach(s => s.classList.remove("active"));
    for(let i=0;i<val;i++) stars[i].classList.add("active");
  });
});
</script>

</body>
</html>